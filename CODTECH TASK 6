# Import necessary libraries
from PIL import Image, ImageEnhance, ImageFilter
import matplotlib.pyplot as plt
import numpy as np
from skimage import exposure, filters, transform

# --- Helper function to display images in a grid ---
def display_images(images, titles, rows=1, cols=None, figsize=(15, 5)):
    if cols is None:
        cols = len(images) // rows if len(images) % rows == 0 else (len(images) // rows) + 1
    fig, axes = plt.subplots(rows, cols, figsize=figsize)
    axes = axes.flatten() if rows > 1 or cols > 1 else [axes]
    for i, (img, title) in enumerate(zip(images, titles)):
        axes[i].imshow(img)
        axes[i].set_title(title)
        axes[i].axis('off')
    for j in range(i + 1, len(axes)):
        fig.delaxes(axes[j]) # Remove unused subplots
    plt.tight_layout()
    plt.show()

# --- Load an example image ---
try:
    img_path = 'example.jpg' # Replace with a path to your image
    original_img = Image.open(img_path).convert("RGB")
except FileNotFoundError:
    print(f"Error: '{img_path}' not found. Please provide a valid image path.")
    # Create a dummy image if no image is found
    original_img = Image.fromarray(np.random.randint(0, 255, (200, 300, 3), dtype=np.uint8))
    print("Using a randomly generated image for demonstration.")

# --- 1. Basic Image Enhancements (Pillow) ---
enhancer = ImageEnhance.Brightness(original_img)
bright_img = enhancer.enhance(1.5) # Increase brightness
enhancer = ImageEnhance.Contrast(original_img)
contrast_img = enhancer.enhance(1.8) # Increase contrast
enhancer = ImageEnhance.Color(original_img)
color_img = enhancer.enhance(2.0) # Increase color saturation

display_images([original_img, bright_img, contrast_img, color_img],
               ['Original', 'Brighter', 'Higher Contrast', 'More Color'],
               rows=1, figsize=(18, 5))

# --- 2. Image Filtering (Pillow) ---
blurred_img = original_img.filter(ImageFilter.GaussianBlur(radius=5))
sharpened_img = original_img.filter(ImageFilter.SHARPEN)
edge_detected_img = original_img.filter(ImageFilter.FIND_EDGES)

display_images([original_img, blurred_img, sharpened_img, edge_detected_img],
               ['Original', 'Blurred', 'Sharpened', 'Edge Detected'],
               rows=1, figsize=(18, 5))

# --- 3. Grayscale Conversion and Sepia Tone (Pillow) ---
grayscale_img = original_img.convert("L") # Convert to grayscale
# Create a sepia-toned image
sepia_img = Image.new('RGB', original_img.size)
for x in range(original_img.width):
    for y in range(original_img.height):
        r, g, b = original_img.getpixel((x, y))
        tr = int(0.393 * r + 0.769 * g + 0.189 * b)
        tg = int(0.349 * r + 0.686 * g + 0.168 * b)
        tb = int(0.272 * r + 0.534 * g + 0.131 * b)
        sepia_img.putpixel((x, y), (min(255, tr), min(255, tg), min(255, tb)))

display_images([original_img, grayscale_img, sepia_img],
               ['Original', 'Grayscale', 'Sepia Tone'],
               rows=1, figsize=(15, 5))

# --- 4. Advanced Styling with scikit-image ---
# Convert to NumPy array for scikit-image operations
img_array = np.array(original_img) / 255.0 # Normalize to [0, 1]

# Histogram Equalization
equalized_img = exposure.equalize_hist(img_array)

# Apply a Canny edge detector
canny_edges = filters.canny(img_array.mean(axis=2), sigma=3) # Use mean of channels for grayscale input

# Resize and rotate
resized_img = transform.resize(img_array, (img_array.shape[0] // 2, img_array.shape[1] // 2), anti_aliasing=True)
rotated_img = transform.rotate(img_array, angle=45, resize=True)

display_images([original_img, equalized_img, canny_edges, resized_img, rotated_img],
               ['Original', 'Histogram Equalized', 'Canny Edges', 'Resized', 'Rotated'],
               rows=2, cols=3, figsize=(18, 10))

# --- 5. Custom Overlay (Pillow) ---
# Create a semi-transparent color overlay
overlay_color = (255, 0, 0, 128) # Red with 50% opacity
overlay_img = Image.new('RGBA', original_img.size, overlay_color)
overlaid_img = Image.alpha_composite(original_img.convert('RGBA'), overlay_img).convert('RGB')

display_images([original_img, overlaid_img],
               ['Original', 'Red Overlay'],
               rows=1, figsize=(10, 5))
